{% extends "base.html" %}

{% block title %}æ§åˆ¶å° - NetSage {% endblock %}

{% block content %}
<div class="dashboard">
    <div class="container">
        <div class="dashboard-header">
            <div class="welcome-section">
                <h1 class="terminal-text">SYSTEM ACCESS GRANTED</h1>
                <p class="user-email">
                    <span class="terminal-prompt">user@</span>{{ user_data.email if user_data.email else user_data.user.email }}
                </p>
                <div class="system-status">
                    <span class="status-indicator online"></span>
                    <span class="status-text">ONLINE</span>
                </div>
                <div class="user-actions">
                    <button class="btn-logout" onclick="logoutUser()">
                        <span class="btn-icon">ğŸšª</span>
                        <span>ç™»å‡º</span>
                    </button>
                </div>
            </div>
            
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">ğŸ”—</span>
                        <span class="stat-label">API Keys</span>
                    </div>
                    <span class="stat-value terminal-text">{{ user_data.api_keys|length }}</span>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">âš¡</span>
                        <span class="stat-label">æ€»ä½¿ç”¨æ¬¡æ•°</span>
                    </div>
                    <span class="stat-value terminal-text">
                        {% set total_usage = user_data.api_keys|sum(attribute='usage_count') %}
                        {{ total_usage }}
                    </span>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">ğŸ¯</span>
                        <span class="stat-label">å‰©ä½™é¢åº¦</span>
                    </div>
                    <span class="stat-value terminal-text">
                        {% set total_limit = user_data.api_keys|sum(attribute='usage_limit') %}
                        {% set total_used = user_data.api_keys|sum(attribute='usage_count') %}
                        {{ total_limit - total_used }}
                    </span>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <span class="stat-icon">ğŸ†“</span>
                        <span class="stat-label">å…¬æµ‹çŠ¶æ€</span>
                    </div>
                    <span class="stat-value terminal-text">FREE</span>
                </div>
            </div>
        </div>

        <div class="danger-zone">
            <div class="danger-header">
                <h3 class="terminal-text">âš ï¸ å±é™©æ“ä½œåŒºåŸŸ</h3>
                <p class="danger-description">ä»¥ä¸‹æ“ä½œä¸å¯é€†è½¬ï¼Œè¯·è°¨æ…æ“ä½œ</p>
            </div>
            <div class="danger-actions">
                <button class="btn-danger" onclick="showDeleteConfirmation()">
                    <span class="btn-icon">ğŸ—‘ï¸</span>
                    <span>æ³¨é”€è´¦æˆ·</span>
                </button>
            </div>
        </div>

        <div class="dashboard-main">
            <div class="section-header">
                <h2 class="terminal-text">API KEY MANAGEMENT</h2>
                <div class="header-actions">
                    <button class="btn-create" onclick="showCreateKeyModal()">
                        <span class="btn-icon">+</span>
                        <span>åˆ›å»ºAPI Key</span>
                    </button>
                    <div class="service-pricing">
                        <span class="pricing-label">æœåŠ¡è®¡è´¹:</span>
                        <span class="service-cost">Search(1æ¬¡)</span>
                        <span class="service-cost">Crawl(2æ¬¡)</span>
                        <span class="service-cost">Crawl+Rerank(3æ¬¡)</span>
                    </div>
                </div>
            </div>
            
            <div class="api-keys-grid">
                {% for key in user_data.api_keys %}
                <div class="api-key-card">
                    <div class="api-key-header">
                        <div class="status-section">
                            <span class="status-badge {% if key.status == 'active' %}status-active{% else %}status-inactive{% endif %}">
                                <span class="status-dot"></span>
                                {{ key.status|upper }}
                            </span>
                        </div>
                        <div class="key-actions">
                            <button class="btn-icon" onclick="toggleApiKey(this)" title="æ˜¾ç¤º/éšè—">
                                <span class="icon">ğŸ‘ï¸</span>
                            </button>
                            <button class="btn-icon" onclick="copyApiKey('{{ key.key }}')" title="å¤åˆ¶">
                                <span class="icon">ğŸ“‹</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="api-key-content">
                        <div class="key-display">
                            <label class="key-label">API KEY</label>
                            <div class="key-value-wrapper">
                                <code class="api-key-value">{{ key.key }}</code>
                                <code class="api-key-mask">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</code>
                            </div>
                        </div>
                        
                        <div class="api-key-details">
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <span class="detail-label">åˆ›å»ºæ—¶é—´</span>
                                    <span class="detail-value">{{ key.created_at }}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">è¿‡æœŸæ—¶é—´</span>
                                    <span class="detail-value">{{ key.expires_at }}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">ä½¿ç”¨é™åˆ¶</span>
                                    <span class="detail-value terminal-text">{{ key.usage_limit }}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">å·²ä½¿ç”¨</span>
                                    <span class="detail-value terminal-text">{{ key.usage_count }}</span>
                                </div>
                            </div>
                            
                            <div class="usage-bar">
                                <div class="usage-progress" style="width: {{ (key.usage_count / key.usage_limit * 100) if key.usage_limit > 0 else 0 }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
.dashboard {
    min-height: 100vh;
    padding: 120px 0 50px;
    background: var(--bg-primary);
}

.dashboard-header {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 3rem;
    align-items: center;
    margin-bottom: 3rem;
    padding: 2rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.welcome-section h1 {
    font-size: 2rem;
    margin-bottom: 1rem;
    letter-spacing: 2px;
}

.user-email {
    color: var(--text-muted);
    font-family: 'Fira Code', monospace;
    font-size: 1rem;
    margin-bottom: 1rem;
}

.terminal-prompt {
    color: var(--text-primary);
}

.system-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--text-primary);
    animation: pulse 2s infinite;
}

.status-indicator.online {
    background: var(--text-primary);
    box-shadow: 0 0 10px var(--text-primary);
}

.status-text {
    color: var(--text-primary);
    font-family: 'Fira Code', monospace;
    font-size: 0.9rem;
    letter-spacing: 1px;
}

.user-actions {
    margin-top: 1.5rem;
}

.btn-logout {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--bg-primary);
    color: var(--text-secondary);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.75rem 1rem;
    font-family: 'Fira Code', monospace;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.btn-logout:hover {
    background: var(--bg-secondary);
    border-color: var(--text-primary);
    color: var(--text-primary);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 255, 65, 0.2);
}

.btn-logout .btn-icon {
    font-size: 1rem;
}

.quick-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
}

.stat-card {
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    border-color: var(--text-primary);
    box-shadow: 0 5px 15px rgba(0, 255, 65, 0.1);
}

.stat-header {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.stat-icon {
    font-size: 1.2rem;
}

.stat-label {
    color: var(--text-muted);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    display: block;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.section-header h2 {
    font-size: 1.5rem;
    letter-spacing: 2px;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.service-pricing {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.8rem;
    color: var(--text-muted);
}

.pricing-label {
    font-weight: bold;
    color: var(--text-secondary);
}

.service-cost {
    background: var(--bg-primary);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    border: 1px solid var(--border);
    font-family: 'Fira Code', monospace;
}

.btn-create {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--gradient);
    color: var(--bg-primary);
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 255, 65, 0.3);
}

.btn-create:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 255, 65, 0.4);
}

.btn-icon {
    font-size: 1.2rem;
    font-weight: bold;
}

.danger-zone {
    background: var(--bg-secondary);
    border: 1px solid #ff6b6b;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 3rem;
    box-shadow: 0 10px 30px rgba(255, 107, 107, 0.1);
}

.danger-header {
    margin-bottom: 1.5rem;
}

.danger-header h3 {
    color: #ff6b6b;
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
    letter-spacing: 1px;
}

.danger-description {
    color: var(--text-muted);
    font-size: 0.9rem;
}

.danger-actions {
    display: flex;
    gap: 1rem;
}

.btn-danger {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #ff6b6b, #ee5a52);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
}

.api-keys-grid {
    display: grid;
    gap: 1.5rem;
}

.api-key-card {
    background: var(--bg-secondary);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 2rem;
    transition: all 0.3s ease;
}

.api-key-card:hover {
    border-color: var(--text-primary);
    box-shadow: 0 10px 30px rgba(0, 255, 65, 0.1);
}

.api-key-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.status-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 1px;
    font-family: 'Fira Code', monospace;
}

.status-badge.status-active {
    background: rgba(0, 255, 65, 0.1);
    color: var(--text-primary);
    border: 1px solid var(--text-primary);
}

.status-badge.status-inactive {
    background: rgba(255, 107, 107, 0.1);
    color: var(--accent);
    border: 1px solid var(--accent);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse 2s infinite;
}

.key-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    background: var(--bg-primary);
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-icon:hover {
    border-color: var(--text-primary);
    color: var(--text-primary);
}

.key-display {
    margin-bottom: 1.5rem;
}

.key-label {
    display: block;
    color: var(--text-primary);
    font-size: 0.8rem;
    letter-spacing: 1px;
    margin-bottom: 0.5rem;
    font-family: 'Fira Code', monospace;
}

.key-value-wrapper {
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1rem;
    font-family: 'Fira Code', monospace;
}

.api-key-value,
.api-key-mask {
    color: var(--text-primary);
    font-size: 0.9rem;
    word-break: break-all;
}

.api-key-mask {
    letter-spacing: 2px;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.detail-item {
    background: var(--bg-primary);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1rem;
}

.detail-label {
    display: block;
    color: var(--text-muted);
    font-size: 0.8rem;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.detail-value {
    color: var(--text-secondary);
    font-weight: 500;
}

.usage-bar {
    width: 100%;
    height: 6px;
    background: var(--bg-primary);
    border-radius: 3px;
    overflow: hidden;
}

.usage-progress {
    height: 100%;
    background: var(--gradient);
    border-radius: 3px;
    transition: width 0.3s ease;
}

@media (max-width: 768px) {
    .dashboard-header {
        grid-template-columns: 1fr;
        gap: 2rem;
    }
    
    .quick-stats {
        grid-template-columns: 1fr;
    }
    
    .section-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .detail-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function toggleApiKey(button) {
    const card = button.closest('.api-key-card');
    const keyValue = card.querySelector('.api-key-value');
    const keyMask = card.querySelector('.api-key-mask');
    const icon = button.querySelector('.icon');
    
    if (keyValue.style.display === 'none') {
        keyValue.style.display = 'block';
        keyMask.style.display = 'none';
        icon.textContent = 'ğŸ™ˆ';
        
        // æ·»åŠ è§†è§‰åé¦ˆ
        button.style.background = 'rgba(0, 255, 65, 0.1)';
        button.style.borderColor = 'var(--text-primary)';
        button.style.color = 'var(--text-primary)';
    } else {
        keyValue.style.display = 'none';
        keyMask.style.display = 'block';
        icon.textContent = 'ğŸ‘ï¸';
        
        // æ¢å¤åŸæ ·å¼
        button.style.background = 'var(--bg-primary)';
        button.style.borderColor = 'var(--border)';
        button.style.color = 'var(--text-secondary)';
    }
}

// åˆå§‹åŒ–æ—¶éšè—æ‰€æœ‰APIå¯†é’¥
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.api-key-value').forEach(el => {
        el.style.display = 'none';
    });
    document.querySelectorAll('.api-key-mask').forEach(el => {
        el.style.display = 'block';
    });
});

// ç”¨æˆ·ç™»å‡ºåŠŸèƒ½
async function logoutUser() {
    const confirmation = confirm(
        `ğŸšª ç¡®è®¤è¦ç™»å‡ºå½“å‰è´¦æˆ·å—ï¼Ÿ\n\n` +
        `æ‚¨å°†éœ€è¦é‡æ–°ç™»å½•æ‰èƒ½è®¿é—®æ§åˆ¶å°ã€‚`
    );
    
    if (!confirmation) {
        return;
    }
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const loadingOverlay = document.createElement('div');
        loadingOverlay.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; 
                        justify-content: center; z-index: 9999; color: var(--text-primary);">
                <div style="text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">ğŸšª</div>
                    <div>æ­£åœ¨ç™»å‡º...</div>
                </div>
            </div>
        `;
        document.body.appendChild(loadingOverlay);
        
        const response = await fetch('/api/logout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        document.body.removeChild(loadingOverlay);
        
        if (response.ok && result.success) {
            alert(
                `âœ… ${result.message}\n\n` +
                `æ‚¨å·²æˆåŠŸç™»å‡ºï¼Œå³å°†è·³è½¬åˆ°ç™»å½•é¡µé¢ã€‚`
            );
            
            // é‡å®šå‘åˆ°ç™»å½•é¡µé¢
            window.location.href = '/login';
        } else {
            alert(`âŒ ç™»å‡ºå¤±è´¥: ${result.error || result.message || 'æœªçŸ¥é”™è¯¯'}`);
        }
    } catch (error) {
        // ç§»é™¤åŠ è½½è¦†ç›–å±‚ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const overlay = document.querySelector('[style*="position: fixed"]');
        if (overlay) {
            document.body.removeChild(overlay);
        }
        alert(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
    }
}

// æ˜¾ç¤ºè´¦æˆ·æ³¨é”€ç¡®è®¤å¯¹è¯æ¡†
function showDeleteConfirmation() {
    const userEmail = '{{ user_data.email if user_data.email else user_data.user.email }}';
    const confirmation = confirm(
        `âš ï¸ ç¡®è®¤è¦æ³¨é”€è´¦æˆ·å—ï¼Ÿ\n\n` +
        `è´¦æˆ·é‚®ç®±: ${userEmail}\n` +
        `æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‚¨çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬:\n` +
        `â€¢ æ‰€æœ‰APIå¯†é’¥\n` +
        `â€¢ ä½¿ç”¨è®°å½•\n` +
        `â€¢ è´¦æˆ·ä¿¡æ¯\n\n` +
        `æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`
    );
    
    if (confirmation) {
        showFinalConfirmation();
    }
}

// æ˜¾ç¤ºæœ€ç»ˆç¡®è®¤å¯¹è¯æ¡†
function showFinalConfirmation() {
    const confirmationText = prompt(
        `æœ€åç¡®è®¤ï¼š\n\n` +
        `è¯·è¾“å…¥ "CONFIRM_DELETE" æ¥ç¡®è®¤æ³¨é”€è´¦æˆ·:`
    );
    
    if (confirmationText === 'CONFIRM_DELETE') {
        deleteAccount();
    } else if (confirmationText !== null) {
        alert('è¾“å…¥ä¸æ­£ç¡®ï¼Œè´¦æˆ·æ³¨é”€å·²å–æ¶ˆã€‚');
    }
}

// æ‰§è¡Œè´¦æˆ·æ³¨é”€
async function deleteAccount() {
    const userEmail = '{{ user_data.email if user_data.email else user_data.user.email }}';
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const loadingOverlay = document.createElement('div');
        loadingOverlay.innerHTML = `
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                        background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; 
                        justify-content: center; z-index: 9999; color: var(--text-primary);">
                <div style="text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 1rem;">â³</div>
                    <div>æ­£åœ¨æ³¨é”€è´¦æˆ·...</div>
                </div>
            </div>
        `;
        document.body.appendChild(loadingOverlay);
        
        const response = await fetch('/api/self-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                email: userEmail,
                app_id: 'app-c',
                confirmation: 'CONFIRM_DELETE'
            })
        });
        
        const result = await response.json();
        document.body.removeChild(loadingOverlay);
        
        if (response.ok) {
            alert(
                `âœ… è´¦æˆ·æ³¨é”€æˆåŠŸï¼\n\n` +
                `é‚®ç®±: ${result.email}\n` +
                `åˆ é™¤çš„APIå¯†é’¥æ•°é‡: ${result.deleted_api_keys}\n` +
                `åˆ é™¤æ—¶é—´: ${result.timestamp}\n\n` +
                `æ‚¨çš„æ‰€æœ‰æ•°æ®å·²è¢«å®Œå…¨åˆ é™¤ã€‚`
            );
            
            // é‡å®šå‘åˆ°é¦–é¡µ
            window.location.href = '/';
        } else {
            alert(`âŒ æ³¨é”€å¤±è´¥: ${result.error || result.message || 'æœªçŸ¥é”™è¯¯'}`);
        }
    } catch (error) {
        document.body.removeChild(document.querySelector('[style*="position: fixed"]'));
        alert(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
    }
}

// æ˜¾ç¤ºåˆ›å»ºAPI Keyå¼¹çª—
function showCreateKeyModal() {
    const modal = document.createElement('div');
    modal.className = 'create-key-modal-overlay';
    modal.innerHTML = `
        <div class="create-key-modal">
            <div class="modal-header">
                <h3>åˆ›å»ºæ–°çš„API Key</h3>
                <button onclick="closeCreateKeyModal()" class="close-btn">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>å¥—é¤ç±»å‹</label>
                    <select id="plan-select">
                        <option value="free">å…è´¹å¥—é¤ (30å¤©, 100æ¬¡)</option>
                        <option value="pro">ä¸“ä¸šå¥—é¤ (90å¤©, 10000æ¬¡)</option>
                        <option value="enterprise">ä¼ä¸šå¥—é¤ (365å¤©, æ— é™)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æœ‰æ•ˆæœŸ (å¤©)</label>
                    <input type="number" id="expires-days" value="30" min="1" max="365">
                </div>
                <div class="form-group">
                    <label>ä½¿ç”¨é™åˆ¶ (æ¬¡)</label>
                    <input type="number" id="usage-limit" value="100" min="1">
                </div>
                <div class="beta-notice">
                    <p>ğŸ†“ å…¬æµ‹æœŸé—´ï¼Œä¸æ”¯æŒåˆ›å»ºAPI Key</p>
                </div>
            </div>
            <!-- <div class="modal-footer">
                <button onclick="closeCreateKeyModal()" class="btn-cancel">å–æ¶ˆ</button>
                <button onclick="createApiKey()" class="btn-confirm">åˆ›å»º</button>
            </div> -->
        </div>
    `;
    
    // æ·»åŠ æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        .create-key-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        .create-key-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            color: var(--text-primary);
            margin: 0;
        }
        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-body {
            padding: 1.5rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .form-group select,
        .form-group input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
        }
        .beta-notice {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }
        .beta-notice p {
            margin: 0;
            color: var(--text-primary);
            text-align: center;
        }
        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        .btn-cancel,
        .btn-confirm {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .btn-cancel {
            background: var(--bg-primary);
            color: var(--text-secondary);
        }
        .btn-confirm {
            background: var(--text-primary);
            color: var(--bg-primary);
            border-color: var(--text-primary);
        }
    `;
    document.head.appendChild(style);
    document.body.appendChild(modal);
    
    // å¥—é¤é€‰æ‹©è”åŠ¨
    document.getElementById('plan-select').addEventListener('change', function() {
        const plan = this.value;
        const expiresInput = document.getElementById('expires-days');
        const limitInput = document.getElementById('usage-limit');
        
        switch(plan) {
            case 'free':
                expiresInput.value = 30;
                limitInput.value = 100;
                break;
            case 'pro':
                expiresInput.value = 90;
                limitInput.value = 10000;
                break;
            case 'enterprise':
                expiresInput.value = 365;
                limitInput.value = 100000;
                break;
        }
    });
}

function closeCreateKeyModal() {
    const modal = document.querySelector('.create-key-modal-overlay');
    if (modal) {
        modal.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(modal);
        }, 300);
    }
}

async function createApiKey() {
    const plan = document.getElementById('plan-select').value;
    const expiresDays = parseInt(document.getElementById('expires-days').value);
    const usageLimit = parseInt(document.getElementById('usage-limit').value);
    
    if (!expiresDays || !usageLimit) {
        alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
        return;
    }
    
    try {
        const response = await fetch('/api/create-api-key', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                plan: plan,
                expires_in_days: expiresDays,
                usage_limit: usageLimit
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            closeCreateKeyModal();
            alert(`âœ… API Keyåˆ›å»ºæˆåŠŸï¼\\n\\nå¯†é’¥: ${result.key}\\n\\nè¯·å¦¥å–„ä¿ç®¡æ‚¨çš„API Keyï¼`);
            location.reload(); // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ–°çš„API Key
        } else {
            alert(`âŒ åˆ›å»ºå¤±è´¥: ${result.error || result.message || 'æœªçŸ¥é”™è¯¯'}`);
        }
    } catch (error) {
        alert(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`);
    }
}

// å¤åˆ¶API Keyåˆ°å‰ªè´´æ¿
function copyApiKey(key) {
    navigator.clipboard.writeText(key).then(() => {
        showNotification('API Keyå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(() => {
        showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
    });
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 6px;
        color: white;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.9rem;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        background: ${type === 'success' ? 'var(--text-primary)' : 'var(--accent)'};
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}
</script>
{% endblock %} 